<template>
  <section
    class="accordion-main"
    v-bind="{ expanded }"
  >
    <button
      @click.prevent="
        hasEverExpanded = true;
        expanded = ! expanded;"
      :class="['header-as-button', expanded ? 'header-border-bottom' : '']"
    >
        <div
          class="title"
          v-text="groupTitle"
        />
        <nav v-show="expanded">
          <button
            @click.stop="
              if( store.gospels.parallelCurrent > 1 )
                store.gospels.parallelCurrent--"
            class="button-parallels"
          >
            â€“
          </button>
          <button
            @click.stop="
              if( store.gospels.parallelCurrent < store.gospels.parallelMax )
                store.gospels.parallelCurrent++"
            class="button-parallels"
          >
            +
          </button>
        </nav>
    </button>

<!-- https://vuejs.org/v2/guide/transitions.html#JavaScript-Hooks -->
    <transition
      @enter="enter"
      @leave="leave"
    >
      <section
        ref="section"
        v-show="expanded"
        class="sub-accordions"
      >
        <!-- Minimise initial DOM nodes for quick page loading -->
        <template v-if="hasEverExpanded">
          <AccordionSub
            v-for="(event,eventIndex) in store.timeline[groupIndex][groupTitle]"
            :key="eventIndex"
            v-bind="{ 
              groupIndex,
              groupTitle,
              eventIndex
            }"
            @parent-transition-required="setHeight"
          />
        </template>
      </section>
    </transition>
  </section>
</template>

<script>
import { store } from "~/components/store";

export default {

  props: {
    groupIndex: Number,
    groupTitle: String,
  },


  data() {
    return {
      store,
      expanded: false,
      hasEverExpanded: false,
      expandAnySubAccordion: 0,
    }
  },


  mounted() {
    this.$refs.section.style.height = 0;
  },


  methods: {

    // https://stackoverflow.com/q/56537331
    enter(el) {
      // https://stackoverflow.com/a/54422687
      requestAnimationFrame(() => {
        el.style.height = el.scrollHeight + "px";
      });    
    },


    leave(el) {
      el.style.height = 0;
    },


    setHeight(heightDiff) {
      this.$refs.section.style.height = 
        Number(this.$refs.section.style.height.slice(0,-2)) + heightDiff + 'px';
    },

  },
  
}
</script>

<style scoped>
  .sub-accordions {
    transition: height 400ms;
    /* overflow: hidden; */
  }

  .accordion-main {
    display: flex;
    flex-direction: column;
    border: 1px solid darkkhaki;
    border-radius: 5px;
    margin: 3px;
    cursor: default;
  }

  .header-as-button {
    all: unset;
    position: sticky;
    position: -webkit-sticky;
    top: 0;
    z-index: 1;
    display: flex;
    align-items: center;
    padding-left: 5px;
    padding-right: 5px;
    background-color: var(--bg-main-accordion-header);
    border-radius: 5px;
  }

  .header-border-bottom {
    border-bottom: 1px solid darkkhaki;
  }

  .title {
    display: flex;
    align-items: center;
    flex: 1;
    min-height: 3em;
    text-align: left;
    font-weight: bold;
    font-family: 'Times New Roman', serif;
  }

  nav {
    display: flex;
    align-items: center;
  }

  .button-parallels {
    all: unset;
    display: inline-block;
    text-align: center;
    width: 1.125em;
    border-radius: 1.125em;
    font-size: 2.25em;
    padding: 0;
    margin: 0;
    cursor: pointer;
    background-color: var(--bg-main-accordion-header);
  }

  .button-parallels:active {
    background-color: hsl(16, 100%, 75%);
  }

  .button-parallels:focus, .header-as-button:focus {
    filter: brightness(95%);
  }

</style>